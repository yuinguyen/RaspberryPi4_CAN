
'''
constants.py
Original driver made by Longan-Labs' MicroPython_CAN_BUS_MCP2515 made for MCUs
that are compatible with MicroPython liek ESP32, RP2040, etc.
The code was then modified to be compatible with the Raspi 4
Modified by: Yui Nguyen
Date: March 16th, 2025
Summarizes all predefined constants for the MCP2515 registers
'''
# CANCTRL Register Operation Modes
class CANCTRL_REQOP_MODE:
    CANCTRL_REQOP_NORMAL = 0x00
    CANCTRL_REQOP_SLEEP = 0x20
    CANCTRL_REQOP_LOOPBACK = 0x40
    CANCTRL_REQOP_LISTENONLY = 0x60
    CANCTRL_REQOP_CONFIG = 0x80
    CANCTRL_REQOP_POWERUP = 0xE0

# MCP2515 CANINTF Register Bits
class CANINTF:
    CANINTF_RX0IF = 0x01
    CANINTF_RX1IF = 0x02
    CANINTF_TX0IF = 0x04
    CANINTF_TX1IF = 0x08
    CANINTF_TX2IF = 0x10
    CANINTF_ERRIF = 0x20
    CANINTF_WAKIF = 0x40
    CANINTF_MERRF = 0x80

# MCP2515 EFLG Register Bits
class EFLG:
    EFLG_RX1OVR = 0x80
    EFLG_RX0OVR = 0x40
    EFLG_TXBO = 0x20
    EFLG_TXEP = 0x10
    EFLG_RXEP = 0x08
    EFLG_TXWAR = 0x04
    EFLG_RXWAR = 0x02
    EFLG_EWARN = 0x01

EFLG_ERRORMASK = 0xF8  # Mask for all error flags

# MCP2515 CANCTRL Register Bits for Clock Output
class CAN_CLKOUT:
    CLKOUT_DISABLE = 0x00
    CLKOUT_DIV1 = 0x01
    CLKOUT_DIV2 = 0x02
    CLKOUT_DIV4 = 0x03
    CLKOUT_DIV8 = 0x04



# MCP2515 TXBnCTRL Register Bits
class TXBnCTRL:
    TXB_ABTF = 0x40
    TXB_MLOA = 0x20
    TXB_TXERR = 0x10
    TXB_TXREQ = 0x08
    TXB_TXIE = 0x04
    TXB_TXP = 0x03

# MCP2515 Transmit Buffer Indices
class TXBn:
    TXB0 = 0
    TXB1 = 1
    TXB2 = 2

# MCP2515 Receive Buffer Indices
class RXBn:
    RXB0 = 0
    RXB1 = 1

# MCP2515 Masks and Filters
class MASK:
    MASK0 = 0
    MASK1 = 1

class RXF:
    RXF0 = 0
    RXF1 = 1
    RXF2 = 2
    RXF3 = 3
    RXF4 = 4
    RXF5 = 5

# MCP2515 Status Bits
class STAT:
    STAT_RX0IF = 0x01
    STAT_RX1IF = 0x02
    STAT_TX0REQ = 0x04
    STAT_TX0IF = 0x08
    STAT_TX1REQ = 0x10
    STAT_TX1IF = 0x20
    STAT_TX2REQ = 0x40
    STAT_TX2IF = 0x80

# CAN configuration constants
class CAN_CLOCK:
    MCP_8MHZ = 0
    MCP_10MHZ = 1
    MCP_16MHZ = 2

class CAN_SPEED:
    CAN_5KBPS = 0
    CAN_10KBPS = 1
    CAN_20KBPS = 2
    CAN_31K25BPS = 3
    CAN_33KBPS = 4
    CAN_40KBPS = 5
    CAN_50KBPS = 6
    CAN_80KBPS = 7
    CAN_83K3BPS = 8
    CAN_95KBPS = 9
    CAN_100KBPS = 10
    CAN_125KBPS = 11
    CAN_200KBPS = 12
    CAN_250KBPS = 13
    CAN_500KBPS = 14
    CAN_666KBPS = 15
    CAN_1000KBPS = 16

# MCP2515 Error Codes
class ERROR:
    ERROR_OK = 0
    ERROR_FAIL = 1
    ERROR_ALLTXBUSY = 2
    ERROR_FAILINIT = 3
    ERROR_FAILTX = 4
    ERROR_NOMSG = 5

# MCP2515 Instruction Set
class INSTRUCTION:
    INSTRUCTION_WRITE = 0x02
    INSTRUCTION_READ = 0x03
    INSTRUCTION_BITMOD = 0x05
    INSTRUCTION_LOAD_TX0 = 0x40
    INSTRUCTION_LOAD_TX1 = 0x42
    INSTRUCTION_LOAD_TX2 = 0x44
    INSTRUCTION_RTS_TX0 = 0x81
    INSTRUCTION_RTS_TX1 = 0x82
    INSTRUCTION_RTS_TX2 = 0x84
    INSTRUCTION_RTS_ALL = 0x87
    INSTRUCTION_READ_RX0 = 0x90
    INSTRUCTION_READ_RX1 = 0x94
    INSTRUCTION_READ_STATUS = 0xA0
    INSTRUCTION_RX_STATUS = 0xB0
    INSTRUCTION_RESET = 0xC0

# MCP2515 Register Addresses
class REGISTER:
    MCP_RXF0SIDH = 0x00
    MCP_RXF0SIDL = 0x01
    MCP_RXF0EID8 = 0x02
    MCP_RXF0EID0 = 0x03
    MCP_RXF1SIDH = 0x04
    MCP_RXF1SIDL = 0x05
    MCP_RXF1EID8 = 0x06
    MCP_RXF1EID0 = 0x07
    MCP_RXF2SIDH = 0x08
    MCP_RXF2SIDL = 0x09
    MCP_RXF2EID8 = 0x0A
    MCP_RXF2EID0 = 0x0B
    MCP_CANSTAT = 0x0E
    MCP_CANCTRL = 0x0F
    MCP_RXF3SIDH = 0x10
    MCP_RXF3SIDL = 0x11
    MCP_RXF3EID8 = 0x12
    MCP_RXF3EID0 = 0x13
    MCP_RXF4SIDH = 0x14
    MCP_RXF4SIDL = 0x15
    MCP_RXF4EID8 = 0x16
    MCP_RXF4EID0 = 0x17
    MCP_RXF5SIDH = 0x18
    MCP_RXF5SIDL = 0x19
    MCP_RXF5EID8 = 0x1A
    MCP_RXF5EID0 = 0x1B
    MCP_TEC = 0x1C
    MCP_REC = 0x1D
    MCP_RXM0SIDH = 0x20
    MCP_RXM0SIDL = 0x21
    MCP_RXM0EID8 = 0x22
    MCP_RXM0EID0 = 0x23
    MCP_RXM1SIDH = 0x24
    MCP_RXM1SIDL = 0x25
    MCP_RXM1EID8 = 0x26
    MCP_RXM1EID0 = 0x27
    MCP_CNF3 = 0x28
    MCP_CNF2 = 0x29
    MCP_CNF1 = 0x2A
    MCP_CANINTE = 0x2B
    MCP_CANINTF = 0x2C
    MCP_EFLG = 0x2D
    MCP_TXB0CTRL = 0x30
    MCP_TXB0SIDH = 0x31
    MCP_TXB0SIDL = 0x32
    MCP_TXB0EID8 = 0x33
    MCP_TXB0EID0 = 0x34
    MCP_TXB0DLC = 0x35
    MCP_TXB0DATA = 0x36
    MCP_TXB1CTRL = 0x40
    MCP_TXB1SIDH = 0x41
    MCP_TXB1SIDL = 0x42
    MCP_TXB1EID8 = 0x43
    MCP_TXB1EID0 = 0x44
    MCP_TXB1DLC = 0x45
    MCP_TXB1DATA = 0x46
    MCP_TXB2CTRL = 0x50
    MCP_TXB2SIDH = 0x51
    MCP_TXB2SIDL = 0x52
    MCP_TXB2EID8 = 0x53
    MCP_TXB2EID0 = 0x54
    MCP_TXB2DLC = 0x55
    MCP_TXB2DATA = 0x56
    MCP_RXB0CTRL = 0x60
    MCP_RXB0SIDH = 0x61
    MCP_RXB0SIDL = 0x62
    MCP_RXB0EID8 = 0x63
    MCP_RXB0EID0 = 0x64
    MCP_RXB0DLC = 0x65
    MCP_RXB0DATA = 0x66
    MCP_RXB1CTRL = 0x70
    MCP_RXB1SIDH = 0x71
    MCP_RXB1SIDL = 0x72
    MCP_RXB1EID8 = 0x73
    MCP_RXB1EID0 = 0x74
    MCP_RXB1DLC = 0x75
    MCP_RXB1DATA = 0x76
    
# MCP2515 Controller Area Network Bits and Masks
N_TXBUFFERS = 3
N_RXBUFFERS = 2

# MCP2515 Control and Status Register Bits
CANSTAT_OPMOD = 0xE0
CANSTAT_ICOD = 0x0E

CANCTRL_REQOP = 0xE0
CANCTRL_ABAT = 0x10
CANCTRL_OSM = 0x08
CANCTRL_CLKEN = 0x04
CANCTRL_CLKPRE = 0x03

# MCP2515 Standard Filter and Mask Entry Indices
MCP_SIDH = 0
MCP_SIDL = 1
MCP_EID8 = 2
MCP_EID0 = 3
MCP_DLC = 4
MCP_DATA = 5

CNF3_SOF = 0x80
RTR_MASK = 0x40
DLC_MASK = 0x0F
TXB_EXIDE_MASK = 0x08

# MCP2515 RXBnCTRL Register Bits
RXBnCTRL_RXM_MASK = 0x60
RXBnCTRL_RXM_STD = 0x00
RXBnCTRL_RXM_EXT = 0x20
RXBnCTRL_RXM_STDEXT = 0x40
RXBnCTRL_RXM_MASK_BITS = 0x60
RXBnCTRL_RTR = 0x08
RXB0CTRL_BUKT = 0x04
RXB0CTRL_FILHIT_MASK = 0x03
RXB1CTRL_FILHIT_MASK = 0x07
RXB0CTRL_FILHIT = 0x00
RXB1CTRL_FILHIT = 0x01

STAT_RXIF_MASK = STAT.STAT_RX0IF | STAT.STAT_RX1IF

# constants.py - Constants for MCP2515 CAN controller implementation

# SPI interface constants
SPI_DEFAULT_BAUDRATE = 1000000  # 10MHz SPI clock
SPI_DUMMY_INT = 0x00
SPI_TRANSFER_LEN = 1
SPI_HOLD_US = 10

# MCP2515 CAN Configuration for different clock frequencies and baudrates
# Format: CFG1, CFG2, CFG3
CAN_CFGS = {
    CAN_CLOCK.MCP_16MHZ: {
        CAN_SPEED.CAN_5KBPS: (0x3F, 0xFF, 0x87),
        CAN_SPEED.CAN_10KBPS: (0x1F, 0xFF, 0x87),
        CAN_SPEED.CAN_20KBPS: (0x0F, 0xFF, 0x87),
        CAN_SPEED.CAN_31K25BPS: (0x0F, 0xF1, 0x85),
        CAN_SPEED.CAN_33KBPS: (0x09, 0xBE, 0x07),
        CAN_SPEED.CAN_40KBPS: (0x07, 0xFF, 0x87),
        CAN_SPEED.CAN_50KBPS: (0x07, 0xFA, 0x87),
        CAN_SPEED.CAN_80KBPS: (0x03, 0xFF, 0x87),
        CAN_SPEED.CAN_83K3BPS: (0x03, 0xBE, 0x07),
        CAN_SPEED.CAN_95KBPS: (0x03, 0xAD, 0x07),
        CAN_SPEED.CAN_100KBPS: (0x03, 0xFA, 0x87),
        CAN_SPEED.CAN_125KBPS: (0x03, 0xF0, 0x86),
        CAN_SPEED.CAN_200KBPS: (0x01, 0xFA, 0x87),
        CAN_SPEED.CAN_250KBPS: (0x41, 0xF1, 0x85),
        CAN_SPEED.CAN_500KBPS: (0x00, 0xF0, 0x86),
        CAN_SPEED.CAN_666KBPS: (0x00, 0xA0, 0x04),
        CAN_SPEED.CAN_1000KBPS: (0x00, 0xD0, 0x82),
    },
    CAN_CLOCK.MCP_8MHZ: {
        CAN_SPEED.CAN_5KBPS: (0x1F, 0xFF, 0x87),
        CAN_SPEED.CAN_10KBPS: (0x0F, 0xFF, 0x87),
        CAN_SPEED.CAN_20KBPS: (0x07, 0xFF, 0x87),
        CAN_SPEED.CAN_31K25BPS: (0x07, 0xA4, 0x04),
        CAN_SPEED.CAN_33KBPS: (0x04, 0xF1, 0x85),
        CAN_SPEED.CAN_40KBPS: (0x04, 0xF1, 0x85),
        CAN_SPEED.CAN_50KBPS: (0x03, 0xFA, 0x87),
        CAN_SPEED.CAN_80KBPS: (0x01, 0xFA, 0x87),
        CAN_SPEED.CAN_83K3BPS: (0x01, 0xF0, 0x86),
        CAN_SPEED.CAN_95KBPS: (0x01, 0xAD, 0x07),
        CAN_SPEED.CAN_100KBPS: (0x01, 0xF0, 0x86),
        CAN_SPEED.CAN_125KBPS: (0x01, 0xF0, 0x86),
        CAN_SPEED.CAN_200KBPS: (0x00, 0xFA, 0x87),
        CAN_SPEED.CAN_250KBPS: (0x00, 0xF0, 0x86),
        CAN_SPEED.CAN_500KBPS: (0x00, 0xF0, 0x86),
        CAN_SPEED.CAN_1000KBPS: (0x00, 0xD0, 0x82),
    },
    CAN_CLOCK.MCP_10MHZ: {
        CAN_SPEED.CAN_5KBPS: (0x3F, 0xFF, 0x87),
        CAN_SPEED.CAN_10KBPS: (0x1F, 0xFF, 0x87),
        CAN_SPEED.CAN_20KBPS: (0x0F, 0xFF, 0x87),
        CAN_SPEED.CAN_31K25BPS: (0x0F, 0xF1, 0x85),
        CAN_SPEED.CAN_33KBPS: (0x09, 0xBE, 0x07),
        CAN_SPEED.CAN_40KBPS: (0x07, 0xFF, 0x87),
        CAN_SPEED.CAN_50KBPS: (0x07, 0xFA, 0x87),
        CAN_SPEED.CAN_80KBPS: (0x03, 0xFF, 0x87),
        CAN_SPEED.CAN_83K3BPS: (0x03, 0xBE, 0x07),
        CAN_SPEED.CAN_95KBPS: (0x03, 0xAD, 0x07),
        CAN_SPEED.CAN_100KBPS: (0x03, 0xFA, 0x87),
        CAN_SPEED.CAN_125KBPS: (0x01, 0xFA, 0x87),
        CAN_SPEED.CAN_200KBPS: (0x00, 0xFA, 0x87),
        CAN_SPEED.CAN_250KBPS: (0x00, 0xF0, 0x86),
        CAN_SPEED.CAN_500KBPS: (0x00, 0xF0, 0x86),
        CAN_SPEED.CAN_1000KBPS: (0x00, 0xD0, 0x82),
    },
}